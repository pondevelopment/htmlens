# HTML to Markdown Conversion

## Overview

The htmlens worker converts HTML page content to Markdown using the `html2md` library from htmlens-core. This provides clean markdown conversion for page content while maintaining our custom CLI-style structured data formatting.

> **Note**: Cloudflare AI's `toMarkdown` API is currently only available in the JavaScript Workers SDK, not yet in the Rust SDK (worker-rs 0.6). We use the `html2md` library instead, which provides good quality HTML to Markdown conversion.

## Architecture

### Two Markdown Outputs

The worker now generates **two different markdown outputs**:

1. **Structured Data Markdown** (`markdown` field)
   - CLI-style formatted tables and summaries
   - Product information extracted from JSON-LD
   - Variant tables with dynamic columns
   - Organization, breadcrumbs, pricing, availability
   - Generated by `format_cli_style_markdown()`

2. **Page Content Markdown** (`pageMarkdown` field)
   - AI-converted HTML content
   - Clean page text without scripts/styles
   - Generated by Cloudflare AI `html-to-markdown` model
   - Fallback to simple extraction if AI fails

### Processing Flow

```
1. Fetch HTML from URL
   ↓
2. Extract JSON-LD blocks (BEFORE sanitization)
   ↓
3. Sanitize HTML (remove scripts, styles using parser::sanitize_html)
   ↓
4. Send sanitized HTML to CF AI toMarkdown
   ↓
5. Build structured data markdown from JSON-LD
   ↓
6. Return both markdown outputs in response
```

## Key Implementation Details

### JSON-LD Stripping

**Important**: We extract JSON-LD blocks **BEFORE** sanitizing HTML because:
- CF AI's toMarkdown would include JSON-LD script content in the output
- We process JSON-LD separately for structured data extraction
- `parser::sanitize_html()` removes all script tags (including JSON-LD)

```rust
// Extract JSON-LD FIRST (from original HTML)
let jsonld_blocks = parser::extract_json_ld_blocks(&html)?;

// THEN sanitize for AI conversion (removes scripts)
let sanitized_html = parser::sanitize_html(&html);

// Send clean HTML to AI (no JSON-LD scripts in output)
let ai_result = env.ai("AI")?.run("@cf/cloudflare/html-to-markdown", ...);
```

### AI Binding Configuration

**wrangler.toml**:
```toml
[ai]
binding = "AI"
```

This creates an AI binding accessible via `env.ai("AI")` in the worker.

### Fallback Strategy

If CF AI fails (network, quota, error), the worker falls back to simple extraction:

```rust
let ai_markdown = if let Some(md) = ai_result.get("markdown") {
    md.to_string()  // Use AI result
} else {
    format!("# {}\n\n{}", title, description)  // Fallback
};
```

## API Response Structure

```json
{
  "url": "https://example.com/product",
  "title": "Product Title",
  "description": "Product description",
  "graph": { "nodes": [...], "edges": [] },
  "jsonld": [...],
  "markdown": "# ProductGroup Table\n...",  // CLI-style structured data
  "pageMarkdown": "# Page Title\n...",      // AI-converted page content
  "meta": {
    "htmlLength": 45000,
    "jsonldCount": 3,
    "wasmStatus": "rust"
  }
}
```

## Frontend Updates

The web UI now has **4 tabs**:

1. **Summary** - JSON metadata overview
2. **JSON-LD** - Raw JSON-LD extracted from page
3. **Structured Data** - CLI-style product tables and analysis
4. **Page Content** - AI-converted HTML page content

## Benefits

### For Users
- **Better page content**: CF AI provides superior HTML to Markdown conversion
- **Structured product data**: Custom formatters extract and display product variants, pricing, availability
- **Clean output**: JSON-LD scripts are removed from page content but still analyzed separately

### For Developers
- **Reusable sanitization**: Uses shared `htmlens-core::parser::sanitize_html()`
- **Graceful degradation**: Falls back to simple extraction if AI unavailable
- **Separation of concerns**: Page content vs. structured data extraction

## Cost Considerations

Cloudflare AI on Workers has:
- **Free tier**: 10,000 Neurons per day
- **Paid tier**: $0.011 per 1,000 Neurons

The `html-to-markdown` model costs vary by input size. Monitor usage via Cloudflare dashboard.

## Testing

### Local Development

```bash
cd crates/htmlens-worker
npm run dev
```

Visit http://localhost:8787 and enter a URL to test both markdown outputs.

### Example URLs

- **E-commerce with variants**: https://www.kalkhoff-bikes.com/de_de/entice-7-advance
- **Complex products**: https://www.focus-bikes.com/nl_nl/paralane-8-8
- **Multiple JSON-LD**: https://www.gazelle.nl/fietsen/tour-populair-c8

## Troubleshooting

### AI Response Missing Markdown Field

**Symptoms**: Worker uses fallback instead of AI output

**Check**:
- AI binding configured in wrangler.toml
- Model name is correct: `@cf/cloudflare/html-to-markdown`
- Input HTML is not empty

### JSON-LD Appears in Page Content

**Should not happen** - we sanitize before sending to AI.

**If it does**:
- Verify `parser::sanitize_html()` is called before AI
- Check that JSON-LD extraction happens before sanitization

### Large HTML Pages Timeout

**Solution**: CF AI has input size limits

- Current implementation sends full sanitized HTML
- Consider truncating extremely large pages (>1MB)
- Or implement chunking for very large documents

## Future Enhancements

- [ ] Add retry logic for AI failures
- [ ] Cache AI results for repeated URLs
- [ ] Support multiple AI models (user configurable)
- [ ] Implement streaming for large documents
- [ ] Add AI-based summary generation from extracted data
